# Perforce Stream Rules Manager 1.0.2 - 使用說明

## 簡介

Perforce Stream Rules Manager是一個 WPF 桌面應用程式，幫助開發者可視化和管理 Perforce Stream的層級結構中的ignore及remap路徑規則，並可儲存修訂紀錄及回復變更。

### 主要功能

- **Stream層級結構可視化**：以樹狀視圖顯示 Stream的層級關係
- **規則管理**：查看、新增、編輯、刪除Stream中的規則
- **多種視圖模式**：本地規則、繼承規則、全部規則
- **快照管理**：建立、比較和恢復規則狀態快照
- **路徑瀏覽器**：直觀地從 Depot 中選擇路徑，避免輸入錯誤
- **歷史追蹤**：查看時間軸上的快照變化

---

## 快速開始

### 1. 啟動應用程式

```bash
dotnet run --project PerforceStreamManager/PerforceStreamManager.csproj
```

### 2. 設定 Perforce 連線

1. 點選選單列的 **Settings** 按鈕
2. 設定以下參數：
   - **Perforce Server**：P4 伺服器位址 (例：localhost:1666)
   - **User**：P4 使用者帳號
   - **Workspace**：使用的 P4 工作區名稱
   - **History Storage Path**：Depot 中存放快照的路徑 (例：//depot/snapshots)
3. 點選 **Test Connection** 驗證設定
4. 點選 **Save**

### 3. 載入Stream

1. 在主視窗的文字欄輸入Stream路徑 (例：//depot/main)
2. 點選 **Load Stream** 按鈕
3. Stream層級結構會顯示在左側的 TreeView 中

---

## 主要操作

### 查看規則

1. **在 TreeView 中選擇Stream**：點選任何Stream節點
2. **切換規則視圖**：在工具列選擇
   - **Local**：僅顯示此Stream定義的規則
   - **Inherited**：顯示父Stream繼承下來的規則
   - **All**：顯示本地和繼承的所有規則

### 新增規則

1. 在 TreeView 選擇Stream
2. 點選工具列的 **Add Rule** 按鈕
3. 在 Rule Dialog 中：
   - 選擇規則類型：**Ignore** 或 **Remap**
   - 輸入路徑（或使用 **Browse** 按鈕從 Depot 選擇）
   - 如果是 Remap 規則，指定目標路徑
4. 點選 **OK** 保存規則

### 編輯規則

1. 在規則清單中選擇要編輯的規則
2. 點選工具列的 **Edit Rule** 按鈕
3. 修改規則詳情
4. 點選 **OK** 保存變更

### 刪除規則

1. 在規則清單中選擇要刪除的規則
2. 點選工具列的 **Delete Rule** 按鈕
3. 確認刪除操作

---

## 快照功能

### 建立快照

快照會保存Stream的當前規則狀態，用於歷史追蹤和恢復。

1. 選擇Stream，點選 **Create Snapshot** 按鈕
2. 在 Snapshot Dialog 中：
   - 輸入快照說明（可選）
3. 點選 **OK** 建立快照
4. 快照會儲存到 Depot 的歷史檔案路徑

### 查看歷史

1. 選擇Stream，點選 **View History** 按鈕
2. History Window 會以時間軸顯示所有快照
3. 點選快照以查看當時的規則狀態

### 比較快照

1. 在 History Window 選擇兩個快照
2. 點選 **Compare** 按鈕
3. 檢視差異：
   - **新增規則**：綠色突顯
   - **移除規則**：紅色突顯
   - **修改規則**：黃色突顯

### 恢復快照

1. 在 History Window 選擇要恢復的快照
2. 點選 **Restore** 按鈕
3. 確認操作
4. Stream的規則會恢復到選中快照的狀態

---

## 路徑瀏覽器

當新增或編輯規則時，可使用路徑瀏覽器直觀選擇 Depot 中的路徑：

1. 在 Rule Dialog 點選 **Browse** 按鈕
2. Depot Browser 會顯示 Depot 的目錄結構
3. 導航至所需路徑
4. 點選選擇
5. 路徑會自動填入規則欄位

---

## 設定選項

### Perforce 連線

- **Server**：Perforce 伺服器位址和埠號
- **User**：P4 使用者帳號
- **Workspace**：使用的 P4 工作區

### 歷史管理

- **History Storage Path**：Depot 中存放快照的根路徑
- **Retention Policy**：
  - **Max Snapshots**：超過此數量時自動刪除最舊的快照
  - **Max Age (Days)**：超過此天數的快照自動刪除

---

## 常見任務

### 檢視累積的規則效果

1. 選擇一個Stream
2. 切換到 **All** 視圖
3. 查看所有本地和繼承的規則
4. 注意每條規則旁的 **Source Stream** 標籤，識別規則定義位置

### 追蹤規則變化

1. 定期建立快照以記錄重要變更
2. 使用 **View History** 檢視時間軸
3. 使用 **Compare** 比較快照查看具體變化

### 回復不需要的變更

1. 在 **History Window** 找到要恢復的快照
2. 點選 **Restore** 按鈕
3. 系統會將Stream的規則恢復到該快照狀態

---

## 工作流程範例

### 場景：為新版本分支設定規則

1. **設定連線**：在 **Settings** 中配置 Perforce 伺服器
2. **載入Stream**：載入根Stream (例：//depot/main)
3. **查看規則**：切換到 **All** 查看繼承的規則
4. **新增規則**：為分支新增新的 Ignore/Remap 規則
5. **建立快照**：點選 **Create Snapshot** 保存初始狀態
6. **追蹤變化**：日後修改規則時，再建立新快照以記錄變化

---

## 故障排除

### 無法連線到 Perforce 伺服器

- 驗證伺服器位址和埠號是否正確
- 確認使用者帳號和工作區已正確配置
- 檢查網路連線和防火牆設定
- 在 **Settings** 中使用 **Test Connection** 診斷問題

### 快照載入失敗

- 確認 **History Storage Path** 正確且可訪問
- 檢查 Perforce 伺服器日誌尋找相關錯誤
- 嘗試在 **Settings** 中重新設定路徑

### 規則編輯不生效

- 確認使用者有足夠權限修改Stream配置
- 檢查Stream未被其他使用者鎖定
- 查看應用程式日誌尋找錯誤詳情 (位置：`%AppData%\PerforceStreamManager\application.log`)

---

## 檔案位置

- **應用程式設定**：`%LocalAppData%\PerforceStreamManager\settings.json`
- **應用程式日誌**：`%AppData%\PerforceStreamManager\application.log`
- **快照檔案**：Perforce Depot (在 **Settings** 中配置的路徑)

---

